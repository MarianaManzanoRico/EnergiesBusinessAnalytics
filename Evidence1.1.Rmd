---
title: "Evidence1.1"
author: "Mariana Manzano Rico"
date: "2023-05-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **Introduction**

Humans are always looking for energy since it is crucial for every process around us, we can’t move, produce, build, or do anything without it, even our bodies need it to survive. That’s why different types of energy around the world exist, some older like petroleum or coal, and other new ones such as solar and wind energy. However, the consumption and production of these energies vary from country to country, it depends on other factors like investment, GDP, equipment, people, research, and obviously, the source to exist in the territory. 

We also need to consider that even if energy is crucial for our lives, how people produce it (and use it) is not the best and has big consequences for our environment. Governments, organizations, and enterprises know it and that it must change, so they are looking for new ways and more friendly with the environment to produce energy and take it to every person in the easiest possible way.

In this case, we have the next problem situation: A company named AK Nacional del Monte, which provides energy for the retail industry needs to know whether it’s best to produce energy with new and renewable methods, to do it in the old way, or both, specifically for Brazil, Canada, Mexico, Haiti, and Venezuela. We, as data analysts, will consider different variables such as consumption of different energy types, production, intensity, GDP, CO2 emissions, and prices, which will be presented in this report.

```{r, include=FALSE}

rm(list=ls())

library(dplyr)
library(forcats)
library(ggplot2)
library(naniar)
library(assertive)
library(purrr)
library(stringr)
library(simputation)
library(tidyr)
library(purrr)
library(tidyverse)
library(scales)

options(scipen = 999, digits = 3)

energy_or<-read.csv("SP_energy.csv")
consumption_or<-read.csv("SP_World Energy_Consumption.csv")
statistics_or<-read.csv("SP_WorldE_all_energy_statistics.csv")

```

# **Description of the variables**

For this, we will use three databases named Energy, Consumption, and Statistics. The first one gives us information about consumption, production, and data of each country from 1980 to 2019, the second one has information about different energy types such as oil, solar, wind, and other renewables from 1900 to 2019. Finally, the third one gives us information about the transactions made by each country for different commodities such as coal, natural gas, and petroleum from 1990 to 2014. The next lines are a few of each database:

```{r, echo=FALSE, results=TRUE}
glimpse(energy_or)
glimpse(consumption_or)
glimpse(statistics_or)
```

However, these databases must be cleaned to make a good analysis of each variable. In this report we won’t give deep explanations of what we did because it is not the main purpose, however, it is necessary to understand what we did to clean the databases and the decisions we took based on what to understand the origin of the final databases.

We did the cleansing process for each database as it is seen in the following lines. 

# **Cleansing Data Bases and Selecting Data**

## **Data Type**

First, we had to change the data type of some variables, from numeric to factor or from character to numeric, for each database. The next tables show the final data type for each column.

### **Energy**

```{r}
#Country<-fct
#Energy_type<-fct
#Year<-fct

energy<-energy_or%>%
  mutate(Country=as.factor(Country), Energy_type=as.factor(Energy_type), Year=as.factor(Year))

glimpse(energy)

```

### **Consumption**

```{r}

## Select the necesary
#iso_code:year, oil_consumption, other_renewable_consumption, renewable_consumption, wind_consumption, solar_consumption.

#iso_code<-fct
#country<-fct
#year<-fct

consumption<-consumption_or%>%
  select(iso_code:year, oil_consumption, other_renewable_consumption, renewables_consumption, wind_consumption, solar_consumption)%>%
  mutate(iso_code=as.factor(iso_code), country=as.factor(country), year=as.factor(year))

glimpse(consumption)

```

### **Statistics**

```{r}

#Unselect quantity_footnotes

#country_or_area<-fct
#commodity_transaction<-fct
#year<-fct
#unit<-fct
#category<-fct

statistics<-statistics_or%>%
  select(-quantity_footnotes)%>%
  mutate(country_or_area=as.factor(country_or_area), commodity_transaction=as.factor(commodity_transaction), year=as.factor(year), unit=as.factor(unit), category=as.factor(category))

glimpse(statistics)

```

## **Filter Data**

At this point, we decided to select only the data crucial for our analysis, this means that we only select the countries that we will study in this report (Brazil, Canada, Venezuela, Mexico, and Haiti). 

```{r}
#Mexico, Brazil, Canada, Venezuela, and Haiti.
#Energy in the old fashion way, shift to different production methods
```

### **Energy**

```{r}

energy<-energy%>%
  filter(Country %in% c("Mexico", "Brazil", "Canada", "Venezuela", "Haiti"))

summary(energy$Energy_type)

```
### **Consumption**

```{r}

consumption<-consumption%>%
  filter(country %in% c("Mexico", "Brazil", "Canada", "Venezuela", "Haiti"))

```

### **Statistics**

```{r}

statistics<-statistics%>%
  filter(country_or_area %in% c("Mexico", "Brazil", "Canada", "Venezuela", "Haiti"), str_detect(category, "coal") |  str_detect(category, "natural_gas") | str_detect(category, "nuclear") | str_detect(category, "petroleum") | str_detect(category, "renewables") | str_detect(category, "oil") | str_detect(category, "wind") | str_detect(category, "solar"), str_detect(commodity_transaction, "final consumption"), !str_detect(commodity_transaction, "Other bituminous coal"), !str_detect(commodity_transaction, "Coking coal"), !str_detect(commodity_transaction, "Hard coal"), !str_detect(commodity_transaction, "White spirit and special boiling point industrial spirits"))

group_by(statistics, category)

#Use "contains" in category
  #All energy
  #coal
  #natural_gas
  #nuclear
  #petroleum
  #renewables
  #oil
  #wind
  #solar

```

The final databases are the following ones: 

```{r}
glimpse(energy)
glimpse(consumption)
glimpse(statistics)
```

## **Uniqueness Restrictions**

We also needed to know if there were complete or partial duplications of registries, but we found there are not any duplicates, so we didn’t have to do anything more in this step.

### Complete duplicates

```{r}

sum(duplicated(energy))
sum(duplicated(consumption))
sum(duplicated(statistics))

```

### Partial duplicates

### **Energy**

```{r}

dup_x <- energy %>% 
  count(X) %>% 
  filter(n > 1)
dup_x

```

## **Category review**

The category review means every category to be correctly presented in the database (for example, having *natural_gas* and *Natural_gas* is not the same in R). We checked each category of each database in order to confirm we don’t have to do any category collapse.

### **Energy**

```{r}

#Country
#Energy_type

sumcounen <-energy%>%
  count(Country)

sumcounen

sumeneren<-energy%>%
  count(Energy_type)

sumeneren

```
### **Consumption**

```{r}

#country
#iso_code

sumcouncon <-consumption%>%
  count(country)

sumcouncon

isocon <-consumption%>%
  count(iso_code)

isocon

```

### **Statistics**

```{r}

#country_or_area
#commodity_transaction
#year
#unit
#category

counst <-statistics%>%
  count(country_or_area)

counst

comst <-statistics%>%
  count(commodity_transaction)

comst

yeast <-statistics%>%
  count(year)

yeast

unist <-statistics%>%
  count(unit)

unist

catst <-statistics%>%
  count(category)

catst

#commodity_transaction
   # brown coal
   #others white spirit...

```

We found we don’t have any problems related to categories.

## **Missing Data**

It is necessary to look for the missing data and that is what we did in this section for each one of the databases:

### **Energy**

```{r}

n_miss(energy)
prop_miss(energy)

```

As we can see, we have 252 registries with NAs, which is the 0.019% of the dataset energy. 

### **Consumption**

```{r}

n_miss(consumption)
prop_miss(consumption)

```

In consumption, we have 1515 NAs which is 0.362% of the dataset.

### **Statistics**

```{r}

n_miss(statistics)
prop_miss(statistics)

```

Finally, in statistics, we don’t have any missing data. 

### Missing Data summary

### **Energy**

```{r}

miss_var_summary(energy)
miss_case_summary(energy)
miss_var_table(energy)
miss_case_table(energy)

energy %>% group_by(Year) %>% miss_var_summary()
energy %>% group_by(Year) %>% miss_case_summary()

```

First, in Energy we see that the Variable with the most NAs is `Energy_consumption` and `Energy_production`, in each one, 7.67% is missing data. On the other hand, the most NAs a registry has in this dataset are three, as we can see in the second table. In the third one, we can see that 63.64% is not missing data. Finally, in the last two tables, we can see that 1980 is the year with the most NAs, especially in the variable `CO2_emission`.

### **Consumption**

```{r}

miss_var_summary(consumption)
miss_case_summary(consumption)
miss_var_table(consumption)
miss_case_table(consumption)

consumption %>% group_by(year) %>% miss_var_summary()
consumption %>% group_by(year) %>% miss_case_summary()

```

In Consumption, we see that all the variables have the same number of NAs unless `iso_code`, `country`, and `year`. At most, a registry can have 5 NAs, and almost all years have NAs in their registries. 

We didn’t do the analysis of Statistics because as we saw before, it doesn’t have missing data. 

### Display of Missing Data

The proportions of missing data in each variable can be seen in the next graphs:

### **Energy**

For energy, it is shown like this: 

```{r}

vis_miss(energy)
vis_miss(energy, cluster = TRUE)

```

### **Consumption**

For Consumption it is seen like this:

```{r}

vis_miss(consumption)
vis_miss(consumption, cluster = TRUE)

```

Another way to see the missing data is per variable in energy and consumption as it is shown in the next images: 

```{r}

gg_miss_var(energy)
gg_miss_var(consumption)

```

We confirm what we saw on the tables, that `Energy_production` and `Energy_consumption` are the variables in energy with the most missing data while in consumption are `wind_consumption`, `solar_consumption`, `renewables_consumption`, `other_renewable_consumption` and `oil_consumption`.

```{r}

gg_miss_var(energy, facet = Country)
gg_miss_var(consumption, facet = country)

```

This also can be seen by country in each of the datasets. In Energy, we see that Haiti, Venezuela, and Mexico are the ones with the most NAs while in Consumption, Haiti is the one with fewer NAs. 

Talking about cases and not variables, the proportion of missing data can be seen like this in each of the databases: 

```{r}

gg_miss_case(energy)
gg_miss_case(consumption)

```

```{r}

gg_miss_case(energy, facet = Country)
gg_miss_case(consumption, facet = country)

```

Again, we can see it by country for each data set. In Energy, Haiti, Mexico, and Venezuela are the ones with the most, and in Consumption, Haiti is the one with the fewer.

### Missing Patterns

On the other hand, some patterns between NAs can be seen in the following graphs. For energy, some NAs in `Energy_production` also have in `Energy_consumption` and some others in `GDP`, some NAs in `GDP` also have it in `CO2_emissions` and finally there are some NAs in `GDP` and `CO2_emissions` that are not related to any other variable.

This is not the same case in Consumption, where the registries that have an NA in any column have as well in the others. 

```{r}

gg_miss_upset(energy)
gg_miss_upset(consumption)

```

### Missing Dependence

It is also important to comprehend the relation between variables with NAs and it is what we did in this section. At first, we must create new columns with nabularies, which tell us if the data of each variable is missing or not missing. 

### **Energy**

```{r}
#Nabulares

bind_shadow(energy, only_miss = TRUE)

```

### **Consumption**

```{r}
#Nabulares

bind_shadow(consumption, only_miss = TRUE)

```

### Variation in one variable according to shortages in another variable

Then we create graphs to visualize these relations, we found that the ones that are related to one another are: 

```{r}
#Missing Data
  #Energy_consumption
  #Energy_production
  #GDP
  #CO2_emission

#Possible Variation
  #Energy_intensity_per_capita
  #Energy_intensity_by_GDP

energy%>%
  bind_shadow()%>%
  ggplot(aes(x = Energy_intensity_per_capita, color = Energy_consumption_NA))+
  geom_density()

energy%>%
  bind_shadow()%>%
  ggplot(aes(x = Energy_intensity_per_capita, color = Energy_production_NA))+
  geom_density()

energy%>%
  bind_shadow()%>%
  ggplot(aes(x = Energy_intensity_per_capita, color = GDP_NA))+
  geom_density()

energy%>%
  bind_shadow()%>%
  ggplot(aes(x = Energy_intensity_per_capita, color = CO2_emission_NA))+
  geom_density()

#Variation
  #Energy_consumption
  #Energy_production
  
energy%>%
  bind_shadow()%>%
  ggplot(aes(x = Energy_intensity_by_GDP, color = Energy_consumption_NA))+
  geom_density()

energy%>%
  bind_shadow()%>%
  ggplot(aes(x = Energy_intensity_by_GDP, color = Energy_production_NA))+
  geom_density()

energy%>%
  bind_shadow()%>%
  ggplot(aes(x = Energy_intensity_by_GDP, color = GDP_NA))+
  geom_density()

energy%>%
  bind_shadow()%>%
  ggplot(aes(x = Energy_intensity_by_GDP, color = CO2_emission_NA))+
  geom_density()

#Variation
  #Energy_consumption
  #Energy_production
  #GDP
  
```

In energy:

* Energy intensity per capita
	+ Energy Consumption
	+ Energy Production

* Energy intensity by GDP
	+ Energy Consumption
	+ Energy Production
	+ GDP

### **Consumption**

```{r}
#Missing
  #oil_consumption
  #other_renewable_consumption
  #renewables_consumption
  #wind_consumption
  #solar_consumption

#Possible variation
  #There is no

```

In consumption, we saw that there is any relation between variables with no missing data and variables with missing, so we didn’t create the charts. 

This is useful to know so in the next steps we can create the imputation models with linear regression with the variables related.

### Imputation

After the analysis of missing data in databases, we had to apply some imputation methods in order to clean them and have more precise results. We made the following methods:

* Below the range
* With the mean
* With linear regression
* With the median
* With 0s

This last method was used because we can suppose that if some data is not registered is because in that country or in that year there was not the energy type we are studying, so it will affect our final results to put some “random” numbers in those cases.

For each imputation model, we created a new database, so it doesn’t affect the original one. 

### **Energy**

First, we create them for Energy.

**Below the range**

In the “Below the range” method, first, we looked for the range of each variable with missing data to understand in which values the model will apply the data. Then we create the new dataset with the applied model. 

```{r}

#Look for the range of each variable
renergycon<-range(energy$Energy_consumption)
renergyprod<-range(energy$Energy_production)
rgdp<-range(energy$GDP)
rco2<-range(energy$CO2_emission)

br_energy <- energy %>%
  bind_shadow(only_miss = TRUE) %>%
  add_label_shadow() %>%
  impute_below_all()

```

**With the mean**

With the mean, we only used the function *impute_mean_all* and keep it in a new object. 

```{r}

mean_energy<- energy%>%
  bind_shadow(only_miss = TRUE)%>%
  add_label_shadow()%>%
  impute_mean_all()

```

**With linear regresion**

In the “Linear regression” model, we used the variables that we found in the analysis of variables in the Missing Data section and created the new database. 

```{r}
lm_energy<-energy%>%
  bind_shadow(only_miss = TRUE)%>%
  add_label_shadow()%>%
  impute_lm(Energy_consumption ~ Energy_intensity_per_capita + Energy_intensity_by_GDP) %>%
  impute_lm(Energy_production ~ Energy_intensity_per_capita + Energy_intensity_by_GDP) %>%
  impute_lm(GDP ~ Energy_intensity_per_capita + Energy_intensity_by_GDP) %>%
  impute_lm(CO2_emission ~ Energy_intensity_per_capita + Energy_intensity_by_GDP)
```

**With the median**

In the same case as in the “Mean model”, we used the function *impute_median_all* to apply the model. 

```{r}

median_energy<- energy%>%
  bind_shadow(only_miss = TRUE)%>%
  add_label_shadow()%>%
  impute_median_all()

```

**With the mode**

In the model with “Mode”, first we looked for the mode of each variable with missing data but we found that the mode is 0 or an NA, so we couldn’t apply this model. It is also important to mention that we had to create the function *modef* because this function doesn’t exist in the used packages. 

```{r}

modef<-function(x){
  y<-unique(x)
  tab<-tabulate(match(x,y))
  y[tab==max(tab)]
}
modef(energy$Energy_consumption)
modef(energy$Energy_production)
modef(energy$GDP)
modef(energy$CO2_emission)

#There is no mode or is 0

```
**With 0s**

Finally, with 0s, we used the function *mutate_if*, so we can look for the registries that have NAs and replace them with 0s. 

```{r}
Na_0_en<-energy%>%
  bind_shadow(only_miss = TRUE)%>%
  add_label_shadow()%>%
  mutate_if(is.numeric, ~replace(., is.na(.), 0))

```

### **Consumption**

In consumption, we applied almost the same methods as we can see in the following lines:

**Below the range**

First, we applied the “Below the range” model.

```{r}

br_consumption<-consumption%>%
  bind_shadow(only_miss = TRUE)%>%
  add_label_shadow()%>%
  impute_below_all()

```

**With the mean**

Then we did the same with the mean.

```{r}

mean_consumption<-consumption%>%
  bind_shadow(only_miss = TRUE)%>%
  add_label_shadow()%>%
  impute_mean_all()

```

**With the median**

And also, with the median.

```{r}

median_consumption<-consumption%>%
  bind_shadow(only_miss = TRUE)%>%
  add_label_shadow()%>%
  impute_median_all()

```

**With the mode**

For the mode, we looked for it in each variable but again found there is no mode. 

```{r}

modef(consumption$oil_consumption)
modef(consumption$other_renewable_consumption)
modef(consumption$renewables_consumption)
modef(consumption$wind_consumption)
modef(consumption$solar_consumption)

#There is no mode

```

**With 0s**

Finally applied the “0s” method in the same way as with Energy. 

```{r}
Na_0_con<-consumption%>%
  bind_shadow(only_miss = TRUE)%>%
  add_label_shadow()%>%
  mutate_if(is.numeric, ~replace(., is.na(.), 0))
```

In this case, we didn't use the "Linear regression" method because there weren’t related variables in this database.

We also have to mention that in each of the models we applied the nabularies to know which data is missing. This was made with the functions *bind_shadow* and *add_label_shadow*.

**Evaluation of the methods**

After having completed all the methods, we have to make an evaluation to understand which is the best one to apply. 

### **Energy**

First, we evaluate the ones in energy. 

```{r}

eva_modelos_energy<-bind_rows(br=br_energy,
                              mean=mean_energy,
                              lm=lm_energy,
                              median=median_energy,
                              Na0=Na_0_en,
                              .id="imp_model")

model_summary_energy<-eva_modelos_energy%>%
  group_by(imp_model)%>%
  nest()%>%
  mutate(mod=map(data,          ~lm(Energy_intensity_by_GDP~Energy_consumption + Energy_production + GDP + CO2_emission,
                     data=.)),
         res=map(mod, residuals),
         pred=map(mod, predict),
         tidy=map(mod, broom::tidy))

model_summary_energy

eval_summary_energy<-model_summary_energy%>%
  select(imp_model, tidy)%>%
  unnest()
eval_summary_energy

error_energy<-eval_summary_energy%>%
  summarize(mean=mean(std.error))%>%
  arrange(mean)

```

What we did was to, first, group all the methods, then calculate the linear regression, and finally do the valuation. 

Our criteria were to use the one with the less std.error, so in the last table, we can see each method ordered from the one with the less error to the one with the most. This tells us that the best one to use in this database is the “Below the range” method.  

### **Consumption**

In consumption, we did exactly the same as can be seen in the following lines:

```{r}

eva_models_consumption<-bind_rows(br=br_consumption,
                              mean=mean_consumption,
                              Na_0 = Na_0_con,
                              .id="imp_model")

model_summary_consumption<-eva_models_consumption%>%
  group_by(imp_model)%>%
  nest()%>%
  mutate(mod=map(data,          ~lm(renewables_consumption~oil_consumption + other_renewable_consumption + wind_consumption + solar_consumption,
                     data=.)),
         res=map(mod, residuals),
         pred=map(mod, predict),
         tidy=map(mod, broom::tidy))
model_summary_consumption

eval_summary_consumption<-model_summary_consumption%>%
  select(imp_model, 
         tidy)%>%
  unnest()
eval_summary_consumption

error_consumption<-eval_summary_consumption%>%
  summarize(mean=mean(std.error))%>%
  arrange(mean)

```

However, even if we see that the “Below the range” method is the one with the less error, we decided to apply the “0s” method because, most probably, in this database, the ones that don’t have values are the ones that don’t have that energy type in those countries or years. 

**Final imputation**

In this section, we applied the final imputation to the real databases. 

```{r}

energy<-energy%>%
  bind_shadow(only_miss = TRUE)%>%
  add_label_shadow()%>%
  impute_below_all()

consumption<-consumption%>%
  bind_shadow(only_miss = TRUE)%>%
  add_label_shadow()%>%
  mutate_if(is.numeric, ~replace(., is.na(.), 0))

```

### Outliers

We also have to check the outliers for each variable in each database. 

### **Energy**

In energy, first, we looked for the median in each variable and then for the standard deviation. After having these results, we calculated the upper and the lower value that is not considered an outlier by adding or subtracting the standard deviation multiplied by 3 to the mean. 

Then, to know which are those outliers we used a filter to look for all of them that are above or below those ranges that we already calculated. 

Finally, with an *ifelse* function, we changed all those outliers to the same ones that we calculated at the beginning (the lowers and uppers)


```{r}

#Mean
#sd
#sd*3 +mean
#every data above those must be changed

mean_en_con<-mean(energy$Energy_consumption)
sd_en_con<-sd(energy$Energy_consumption)

mean_en_prod<-mean(energy$Energy_production)
sd_en_prod<-sd(energy$Energy_production)

mean_enGDP<-mean(energy$GDP)
sd_enGDP<-sd(energy$GDP)

mean_enCO2<-mean(energy$CO2_emission)
sd_enCO2<-sd(energy$CO2_emission)

mean_en_int<-mean(energy$Energy_intensity_per_capita)
sd_en_int<-sd(energy$Energy_intensity_per_capita)

mean_en_intGDP<-mean(energy$Energy_intensity_by_GDP)
sd_en_intGDP<-sd(energy$Energy_intensity_by_GDP)

mean_enPop<-mean(energy$Population)
sd_enPop<-sd(energy$Population)


en_con_upper<-mean_en_con+(3*sd_en_con)
en_con_lower<-mean_en_con-(3*sd_en_con)

en_prod_upper<-mean_en_prod+(3*sd_en_prod)
en_prod_lower<-mean_en_prod-(3*sd_en_prod)

enGDP_upper<-mean_enGDP+(3*sd_enGDP)
enGDP_lower<-mean_enGDP-(3*sd_enGDP)

enCO2_upper<-mean_enCO2+(3*sd_enCO2)
enCO2_lower<-mean_enCO2-(3*sd_enCO2)

en_int_upper<-mean_en_int+(3*sd_en_int)
en_int_lower<-mean_en_int-(3*sd_en_int)

en_intGDP_upper<-mean_en_intGDP+(3*sd_en_intGDP)
en_intGDP_lower<-mean_en_intGDP-(3*sd_en_intGDP)

enPop_upper<-mean_enPop+(3*sd_enPop)
enPop_lower<-mean_enPop-(3*sd_enPop)


filter_outliers_energy<-energy%>%
  filter(Energy_consumption < en_con_lower | Energy_consumption > en_con_upper | Energy_production < en_prod_lower | Energy_production > en_con_upper | GDP < enGDP_lower | GDP > enGDP_upper | CO2_emission < enCO2_lower | CO2_emission > enCO2_upper | Energy_intensity_per_capita < en_int_lower | Energy_intensity_per_capita > en_int_upper | Energy_intensity_by_GDP < en_intGDP_lower | Energy_intensity_by_GDP > en_intGDP_upper | Population < enPop_lower | Population > enPop_upper)


energy$Energy_consumption<-ifelse(energy$Energy_consumption < en_con_lower, en_con_lower, energy$Energy_consumption)
energy$Energy_consumption<-ifelse(energy$Energy_consumption > en_con_upper, en_con_upper, energy$Energy_consumption)

energy$Energy_production<-ifelse(energy$Energy_production < en_prod_lower, en_prod_lower, energy$Energy_production)
energy$Energy_production<-ifelse(energy$Energy_production > en_prod_upper, en_prod_upper, energy$Energy_production)

energy$GDP<-ifelse(energy$GDP < enGDP_lower, enGDP_lower, energy$GDP)
energy$GDP<-ifelse(energy$GDP > enGDP_upper, enGDP_upper, energy$GDP)

energy$CO2_emission<-ifelse(energy$CO2_emission < enCO2_lower, enCO2_lower, energy$CO2_emission)
energy$CO2_emission<-ifelse(energy$CO2_emission > enCO2_upper, enCO2_upper, energy$CO2_emission)

energy$Energy_intensity_per_capita<-ifelse(energy$Energy_intensity_per_capita < en_int_lower, en_int_lower, energy$Energy_intensity_per_capita)
energy$Energy_intensity_per_capita<-ifelse(energy$Energy_intensity_per_capita > en_int_lower, en_int_lower, energy$Energy_intensity_per_capita)

energy$Energy_intensity_by_GDP<-ifelse(energy$Energy_intensity_by_GDP < en_intGDP_lower, en_intGDP_lower, energy$Energy_intensity_by_GDP)
energy$Energy_intensity_by_GDP<-ifelse(energy$Energy_intensity_by_GDP > en_intGDP_upper, en_intGDP_upper, energy$Energy_intensity_by_GDP)

energy$Population<-ifelse(energy$Population < enPop_lower, enPop_lower, energy$Population)
energy$Population<-ifelse(energy$Population > enPop_upper, enPop_upper, energy$Population)

energy [ energy < 0 ] <- 0

```

### **Consumption**

We did the same process in consumption to fix the outliers.

```{r}

#oil_consumption
#other_renewable_consumption
#renewables_consumption
#wind_consumption
#solar_consumption

mean_oil_con<-mean(consumption$oil_consumption)
sd_oil_con<-sd(consumption$oil_consumption)

mean_oth_con<-mean(consumption$other_renewable_consumption)
sd_oth_con<-sd(consumption$other_renewable_consumption)

mean_ren_con<-mean(consumption$renewables_consumption)
sd_ren_con<-mean(consumption$renewables_consumption)

mean_win_con<-mean(consumption$wind_consumption)
sd_win_con<-sd(consumption$wind_consumption)

mean_sol_con<-mean(consumption$solar_consumption)
sd_sol_con<-sd(consumption$solar_consumption)


co_oil_upper<-mean_oil_con+(3*sd_oil_con)

co_oth_upper<-mean_oth_con+(3*sd_oth_con)

co_ren_upper<-mean_ren_con+(3*sd_ren_con)

co_win_upper<-mean_win_con+(3*sd_win_con)

co_sol_upper<-mean_sol_con+(3*sd_sol_con)


consumption$oil_consumption<-ifelse(consumption$oil_consumption > co_oil_upper, co_oil_upper, consumption$oil_consumption)

consumption$other_renewable_consumption<-ifelse(consumption$other_renewable_consumption > co_oth_upper, co_oth_upper, consumption$other_renewable_consumption)

consumption$renewables_consumption<-ifelse(consumption$renewables_consumption > co_ren_upper, co_ren_upper, consumption$renewables_consumption)

consumption$wind_consumption<-ifelse(consumption$wind_consumption > co_win_upper, co_win_upper, consumption$wind_consumption)

consumption$solar_consumption<-ifelse(consumption$solar_consumption > co_sol_upper, co_sol_upper, consumption$solar_consumption)

```

In statistics, we didn’t apply this because, if we give a look at the database, we see that there is only one column with numbers which means the number of units operated in each country and for each energy type, however, these units are not the same, some are calculated in terajoules, others in metric tons thousands, etc. we can’t apply a method for outliers because not all registries are calculated in the same way. 

# **Analysis**

Finally,  and after cleaning our databases, we will make a first analysis of the variables and their relations.

### **Energy Consumption**

#### **Mean and Standard Deviation**

Energy consumption is from our database Energy, first, we want to know the total mean and standard deviation of consumption, no matter the energy type or country.

```{r}

mean(energy$Energy_consumption)
sd(energy$Energy_consumption)

```

**For each country**

However, it is also important to look for them by country.

```{r}

group_by(energy, Country)%>%
  filter(Energy_type!="all_energy_types")%>%
  summarize(mean=mean(Energy_consumption))%>%
  arrange(desc(mean))

group_by(energy, Country)%>%
  filter(Energy_type!="all_energy_types")%>%
  summarize(sd=sd(Energy_consumption))%>%
  arrange(desc(sd))

```

We can see that the one with the highest mean is Canada with 2.4.The lowest one is Haiti with 0.005. In standard deviation, we see the same results. 

**By country and Energy type**

```{r}

group_by(energy, Country, Energy_type)%>%
  filter(Energy_type!="all_energy_types")%>%
  summarize(mean=mean(Energy_consumption))%>%
  arrange(desc(mean))

group_by(energy, Country, Energy_type)%>%
  filter(Energy_type!="all_energy_types")%>%
  summarize(sd=sd(Energy_consumption))%>%
  arrange(desc(sd))

```

Divided by energy type and country, we found that the one with the highest mean is Canada with petroleum (4.05), then Brazil with petroleum (3.9), and Mexico with petroleum again (3.7). The lowest ones are Haiti and Venezuela with nuclear (it seems they don’t have this energy type) and Haiti with natural gas, coal, and renewables, and others. 

#### **Distribution**

```{r}

hist(energy$Energy_consumption)

ggplot(energy, aes(x=Energy_consumption))+
  geom_histogram()+
  facet_wrap(~Country)+
  labs(title="Distribution of Data by country",
       subtitle="Energy Consumption")

```

It is also important to understand the distribution of this variable. In the first graph, we see that most of the data is in the first places and continuously is going down to the last places. Divided by country, the one with the most normal distribution might be Canada, the other ones also have most of the data in the first places and less in the last ones and Haiti has all its data grouped in the same range. 

#### **Use of energy in the last year registered for each country**

```{r}

energy_consumption_2019<-energy%>%
  filter(Year==2019, Energy_type!="all_energy_types")%>%
  group_by(Country)%>%
  mutate(Total=sum(Energy_consumption), Percentage=Energy_consumption/Total*100)

ggplot(data=energy_consumption_2019,aes(x="",y=Percentage, fill=Energy_type))+
  geom_bar(stat = "identity",color="white")+
    geom_text(aes(label=percent(Percentage/100)),
              position=position_stack(vjust=0.5),color="black",size=2)+
  coord_polar(theta="y")+
  facet_wrap(~Country)+
  labs(title="Proportions of energy by country",
      subtitle="2019")

```

We also want to know how much of each energy was used in the last year registered (2019 in this case) by country, so we did a pie graph to understand this. In almost all countries the one that is used the most is petroleum. Canada, Mexico, and Venezuela consume big quantities as well of natural gas, Brazil, Canada, and Venezuela are the ones with the most use of renewable energy and Haiti only uses petroleum and a little renewable. 

#### **Growth**

We looked for the growth of consumption by energy type in each country and did some graphs to visualize it. 

```{r}

energy_consumption_mexico<-energy%>%
  filter( Country=="Mexico")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_consumption_mexico, mapping=aes(x=Year, y=Energy_consumption, color=Energy_type))+
  geom_line()+
  labs(title="Energy Growth in Mexico",
       subtitle="1980-2019")

energy_consumption_brazil<-energy%>%
  filter( Country=="Brazil")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_consumption_brazil, mapping=aes(x=Year, y=Energy_consumption, color=Energy_type))+
  geom_line()+
  labs(title="Energy Growth in Brazil",
       subtitle="1980-2019")

energy_consumption_canada<-energy%>%
  filter( Country=="Canada")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_consumption_canada, mapping=aes(x=Year, y=Energy_consumption, color=Energy_type))+
  geom_line()+
  labs(title="Energy Growth in Canada",
       subtitle="1980-2019")

energy_consumption_venezuela<-energy%>%
  filter( Country=="Venezuela")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_consumption_venezuela, mapping=aes(x=Year, y=Energy_consumption, color=Energy_type))+
  geom_line()+
  labs(title="Energy Growth in Venezuela",
       subtitle="1980-2019")

energy_consumption_haiti<-energy%>%
  filter( Country=="Haiti")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_consumption_haiti, mapping=aes(x=Year, y=Energy_consumption, color=Energy_type))+
  geom_line()+
  labs(title="Energy Growth in Haiti",
       subtitle="1980-2019")

```

In Mexico, we see that the highest in consumption is petroleum (with a decrease in some moments) but that natural gas had a growth in the last years. Nuclear, renewables, and coal are the ones less used and with no growth. 

In Brazil, the ones with the most growth are petroleum and renewables, in Canada petroleum and Natural Gas, in Venezuela petroleum and natural gas had a growth but then decrease their consumption and in Haiti the one with the most growth is petroleum. 

### **Energy production**

We did the same analysis for Energy Production in energy. 

#### **Mean and Standard Deviation**

```{r}

mean(energy$Energy_production)
sd(energy$Energy_production)

```

First, we took the mean and standard deviation of all energies and countries which are 2.48 and 3.48 respectively. 

**For each country**

```{r}

group_by(energy, Country)%>%
  filter(Energy_type!= "all_energy_types")%>%
  summarize(mean=mean(Energy_production))%>%
  arrange(desc(mean))

group_by(energy, Country)%>%
  filter(Energy_type!= "all_energy_types")%>%
  summarize(sd=sd(Energy_production))%>%
  arrange(desc(sd))

```
Then we calculated the mean and standard deviation by country, Canada with the highest production (3.32) and Haiti with the lowest (0.0004). 

**By country and Energy type**

```{r}

group_by(energy, Country, Energy_type)%>%
  filter(Energy_type!= "all_energy_types")%>%
  summarize(mean=mean(Energy_production))%>%
  arrange(desc(mean))

group_by(energy, Country, Energy_type)%>%
  filter(Energy_type!= "all_energy_types")%>%
  summarize(sd=sd(Energy_production))%>%
  arrange(desc(sd))

```

Finally, we did the same calculations by energy and country. Mexico is the biggest producer of petroleum with 6.37, then Canada (5.68) and Venezuela (5.43). We see that Haiti doesn’t produce coal, natural gas, nuclear energy, and petroleum while Venezuela doesn’t produce nuclear energy. 

#### **Distribution**

In the distribution analysis of this variable, we see that most of the cases are valued in the first positions. Divided by countries, Brazil, Mexico, and Venezuela have most of their data in the first positions, Haiti all of it, and Canada’s data is registered in different positions. 

```{r}

hist(energy$Energy_production)

ggplot(energy, aes(x=Energy_production))+
  geom_histogram()+
  facet_wrap(~Country)+
  labs(title="Distribution of Data by country",
       subtitle="Energy Production")

```

#### **Production of energy in the last year registered for each country**

```{r}

energy_production_2019<-energy%>%
  filter(Year==2019, Energy_type!="all_energy_types")%>%
  group_by(Country)%>%
  mutate(Total=sum(Energy_production), Percentage=Energy_production/Total*100)

ggplot(data=energy_production_2019,aes(x="",y=Percentage, fill=Energy_type))+
  geom_bar(stat = "identity",color="white")+
    geom_text(aes(label=percent(Percentage/100)),
              position=position_stack(vjust=0.9),color="black",size=2)+
  coord_polar(theta="y")+
  facet_wrap(~Country)+
  labs(title="Proportion of production by energy in each country",
       subtitle="2019")

```

In the proportion of production of energy in each country, we did a pie chart where we can see that Brazil, Canada, Mexico, and Venezuela have most of their production focused on petroleum while Haiti has it in renewables. 

#### **Growth**

```{r}

energy_production_mexico<-energy%>%
  filter( Country=="Mexico")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_production_mexico, mapping=aes(x=Year, y=Energy_production, color=Energy_type))+
  geom_line()+
  labs(title="Energy Production Growth in Mexico",
       subtitle="1980-2019")

energy_production_brazil<-energy%>%
  filter( Country=="Brazil")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_production_brazil, mapping=aes(x=Year, y=Energy_production, color=Energy_type))+
  geom_line()+
  labs(title="Energy Production Growth in Brazil",
       subtitle="1980-2019")

energy_production_canada<-energy%>%
  filter( Country=="Canada")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_production_canada, mapping=aes(x=Year, y=Energy_production, color=Energy_type))+
  geom_line()+
  labs(title="Energy Production Growth in Canada",
       subtitle="1980-2019")

energy_production_venezuela<-energy%>%
  filter( Country=="Venezuela")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_production_venezuela, mapping=aes(x=Year, y=Energy_production, color=Energy_type))+
  geom_line()+
  labs(title="Energy Production Growth in Venezuela",
       subtitle="1980-2019")

energy_production_haiti<-energy%>%
  filter( Country=="Haiti")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_production_haiti, mapping=aes(x=Year, y=Energy_production, color=Energy_type))+
  geom_line()+
  labs(title="Energy Production Growth in Haiti",
       subtitle="1980-2019")

```

With a line graph did it with ggplot2 and the function *geom_line*, we looked for the production growth in each country and by energy type. In Mexico, there was an increase in petroleum but then went down as well with natural gas. In Brazil, petroleum and renewables have increased and also we can see a little one in natural gas.

### **GDP**

Then we did the analysis for GDP.

#### **Mean and Standard Deviation**

The mean of all the studied countries is 1052.

```{r}

mean(energy$GDP)
sd(energy$GDP)

```

**For each country**

```{r}

group_by(energy, Country)%>%
  filter(Energy_type!= "all_energy_types")%>%
  summarize(mean=mean(GDP))%>%
  arrange(desc(mean))

group_by(energy, Country)%>%
  filter(Energy_type!= "all_energy_types")%>%
  summarize(sd=sd(GDP))%>%
  arrange(desc(sd))

```

Divided by country, Brazil has shown the highest GDP with 633.7, then Mexico and at the end Haiti with 11.

#### **Distribution**

```{r}

hist(energy$GDP)

ggplot(energy, aes(x=GDP))+
  geom_histogram()+
  facet_wrap(~Country)+
  labs(title="Distribution of Data by country",
       subtitle="GDP")

```

In the distribution of the data, using the *hist* function, we see the next distribution of all registries and by country. 

#### **GDP of each country**

```{r}

GDP_2019<-energy%>%
  filter(Year==2019, Energy_type=="all_energy_types")%>%
  mutate(Total=sum(GDP), Percentage=GDP/Total*100)

ggplot(data=GDP_2019,aes(x="",y=Percentage, fill=Country))+
  geom_bar(stat = "identity",color="white")+
    geom_text(aes(label=percent(Percentage/100)),
              position=position_stack(vjust=0.9),color="black",size=2)+
  coord_polar(theta="y")+
  labs(title="GDP of each country",
       subtitle="2019")

```

Then we did the analysis of the proportion of GDP between countries, Brazil is the one with the highest GDP. 

#### **Growth**

Finally, we looked at the growth of each country. As we see, Brazil, Canada, and Mexico are the ones that had shown an increase while Venezuela and Haiti don’t. 

```{r}

energy_GDP_mexico<-energy%>%
  mutate(Year=as.numeric(Year))

ggplot(data=energy_GDP_mexico, mapping=aes(x=Year, y=GDP))+
  geom_line()+
  facet_wrap(~Country)+
  labs(title="GDP Growth by country")

```

### **Energy intensity by GDP**

#### **Mean and Standard Deviation**

The total mean of all countries is 5.29 and with a standard deviation of 3.55 in Energy intensity by GDP.

```{r}

mean(energy$Energy_intensity_by_GDP)
sd(energy$Energy_intensity_by_GDP)

```

**For each country**

```{r}

group_by(energy, Country)%>%
  filter(Energy_type!= "all_energy_types")%>%
  summarize(mean=mean(Energy_intensity_by_GDP))%>%
  arrange(desc(mean))

group_by(energy, Country)%>%
  filter(Energy_type!= "all_energy_types")%>%
  summarize(sd=sd(Energy_intensity_by_GDP))%>%
  arrange(desc(sd))

```

By country, we can see that Canada is, again, the highest with 10.98 and Haiti lowest with 0.843.

#### **Distribution**

```{r}

hist(energy$Energy_intensity_by_GDP)

ggplot(energy, aes(x=Energy_intensity_by_GDP))+
  geom_histogram()+
  facet_wrap(~Country)+
  labs(title="Distribution of Data by country",
       subtitle="Energy intensity by GDP")

```

In the distribution, we can see that this case is different from the one of energy consumption, energy production, and GDP. From the total data of Energy Intensity by GDP we see that most of it is located almost in the first places, something similar happens when is divided by countries unless Venezuela and Canada, where most of its registries are located in the medium and in the final. 

#### **Growth**

```{r}

energy_int_GDP_mexico<-energy%>%
  mutate(Year=as.numeric(Year))

ggplot(data=energy_int_GDP_mexico, mapping=aes(x=Year, y=Energy_intensity_by_GDP))+
  geom_line()+
  facet_wrap(~Country)+
  labs(title="Energy intensity by GDP growth by country")

```

In growth, we can see that Venezuela has the highest increase in intensity by GDP, Canada presents a decrease, and Brazil, Mexico, and Haiti almost maintain the same.

### **CO2 Emissions**

We also did the analysis of CO2 emissions, which is important for the decision-making we want to achieve at the end of this project. 

#### **Mean and Standard Deviation**

The total mean is 83.6 while the standard deviation is 129, which means that there really is a big variability between data. 

```{r}

mean(energy$CO2_emission)
sd(energy$CO2_emission)

```

**For each country**

```{r}

group_by(energy, Country)%>%
  filter(Energy_type!= "all_energy_types")%>%
  summarize(mean=mean(CO2_emission))%>%
  arrange(desc(mean))

group_by(energy, Country)%>%
  filter(Energy_type!= "all_energy_types")%>%
  summarize(sd=sd(CO2_emission))%>%
  arrange(desc(sd))

```

Divided by country, we can see that the one with the most CO2 emissions produced by energy is again Canada with 99.04, while Haiti is the one with the less (0.733).

**By country and Energy type**

Finally, talking about mean and divided by country and energy type, the ones that produce the most CO2 emissions are Brazil, Mexico, and Canada with petroleum.  

```{r}

group_by(energy, Country, Energy_type)%>%
  filter(Energy_type!= "all_energy_types")%>%
  summarize(mean=mean(CO2_emission))%>%
  arrange(desc(mean))

group_by(energy, Country, Energy_type)%>%
  filter(Energy_type!= "all_energy_types")%>%
  summarize(sd=sd(CO2_emission))%>%
  arrange(desc(sd))

```

#### **Distribution**

The distribution is viewed more at the left of the chart, while divided by country we can see almost the same behavior in Brazil, Canada, Mexico, and Venezuela. Haiti has all its data at the beginning again.  

```{r}

hist(energy$CO2_emission)

ggplot(energy, aes(x=CO2_emission))+
  geom_histogram()+
  facet_wrap(~Country)+
  labs(title="Distribution of Data by country",
       subtitle="CO2 emissions")

```

#### **CO2 emissions per energy in the last recorded year for each country**

```{r}

CO2_2019<-energy%>%
  filter(Year==2019, Energy_type!="all_energy_types")%>%
  group_by(Country)%>%
  mutate(Total=sum(CO2_emission), Percentage=CO2_emission/Total*100)

ggplot(data=CO2_2019,aes(x="",y=Percentage, fill=Energy_type))+
  geom_bar(stat = "identity",color="white")+
    geom_text(aes(label=percent(Percentage/100)),
              position=position_stack(vjust=0.9),color="black",size=2)+
  coord_polar(theta="y")+
  facet_wrap(~Country)+
  labs(title="Proportion of CO2 emissions by country",
       subtitle="2019")

```

Divided by energy and to know the proportions, we can see that petroleum is the one that produces the most CO2 emissions in all countries, while coal and natural gas are the other ones with the most emissions. 

#### **Growth**

```{r}

energy_CO2_mexico<-energy%>%
  filter( Country=="Mexico")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_CO2_mexico, mapping=aes(x=Year, y=CO2_emission, color=Energy_type))+
  geom_line()+
  labs(title="CO2 emissions growth in Mexico",
       subtitle="1980-2019")

energy_CO2_brazil<-energy%>%
  filter( Country=="Brazil")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_CO2_brazil, mapping=aes(x=Year, y=CO2_emission, color=Energy_type))+
  geom_line()+
  labs(title="CO2 emissions growth in Brazil",
       subtitle="1980-2019")

energy_CO2_canada<-energy%>%
  filter( Country=="Canada")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_CO2_canada, mapping=aes(x=Year, y=CO2_emission, color=Energy_type))+
  geom_line()+
  labs(title="CO2 emissions growth in Canada",
       subtitle="1980-2019")

energy_CO2_venezuela<-energy%>%
  filter( Country=="Venezuela")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_CO2_venezuela, mapping=aes(x=Year, y=CO2_emission, color=Energy_type))+
  geom_line()+
  labs(title="CO2 emissions growth in Venezuela",
       subtitle="1980-2019")

energy_CO2_haiti<-energy%>%
  filter( Country=="Haiti")%>%
  mutate(Year=as.numeric(Year))%>%
  group_by(Energy_type)

ggplot(data=energy_CO2_haiti, mapping=aes(x=Year, y=CO2_emission, color=Energy_type))+
  geom_line()+
  labs(title="CO2 emissions growth in Haiti",
       subtitle="1980-2019")

```

To know how much the CO2 emissions produced by energy had grown in the last years, we did the following graphs. As we can see, petroleum, natural gas, and coal in Mexico have an increase, in Brazil only petroleum and natural gas, in Canada, petroleum had a growth while coal went down. The CO2 emissions caused by petroleum in Venezuela increased but then decreased, the same with natural gas. Finally, in Haiti, petroleum represents almost the whole emissions of that country. 

#### **Some relations**

**Energy consumption and production**

```{r}
energy_types<-energy%>%
  group_by(Energy_type)

ggplot(data=energy_types, mapping=aes(x=Energy_production, y=Energy_consumption, color=Energy_type))+
  geom_point()+
  geom_smooth()+
  facet_wrap(~Country)+
  labs(title="Energy consumption and production",
       subtitle="By country")

energy_country<-energy%>%
  group_by(Country)

ggplot(data=energy_country, mapping=aes(x=Energy_production, y=Energy_consumption, color=Country))+
  geom_point()+
  geom_smooth()+
  facet_wrap(~Energy_type)+
  labs(title="Energy consumption and production",
       subtitle="By Energy type")

```

First, we looked at the relationship between energy consumption and production. For this (and is almost the same steps we followed for the next graphs), we grouped the database by energy type and created the tables divided by countries. We find there is not a lot of relation in some places but in Brazil and Canada is visible. 

We also constructed the graphs by grouping them by country and dividing them by energy type, here we confirm that Brazil is the one that presents the strongest relationship between consumption and production, and renewables is the type with the strongest relation. 

**Energy production and GDP**

```{r}

ggplot(data=energy_types, mapping=aes(x=Energy_production, y=GDP, color=Energy_type))+
  geom_point()+
  geom_smooth()+
  facet_wrap(~Country)+
  labs(title="Energy production and GDP",
       subtitle="By Country")

ggplot(data=energy_country, mapping=aes(x=Energy_production, y=GDP, color=Country))+
  geom_point()+
  geom_smooth()+
  facet_wrap(~Energy_type)+
  labs(title="Energy production and GDP",
       subtitle="By Energy type")

```

Looking for the relation between GDP and energy production and using the functions *geom_point* and *geom_bat*, we found that in Brazil, Canada, and Mexico, as GDP increases the production does it as well. Also, no matter the growth in GDP, the production of coal and nuclear energy will maintain the same. 

**Energy intensity by GDP and Population**

```{r}

ggplot(data=energy_country, mapping=aes(x=Population, y=Energy_intensity_by_GDP, color=Country))+
  geom_point()+
  geom_smooth()+
  facet_wrap(~Country)+
  labs(title="Energy intensity by GDP and Population",
       subtitle="By Country")

```

Finally, we looked at the relationship between intensity by GDP and population, which is not exactly strong and the behavior between countries is very different.

### **Some Energies**

In the dataset Consumrption is information about other energies not studied in the one of Energy, that’s why we will look for some information inside these variables in the following lines: 

#### **Average and Standard Deviation**

```{r}

mean_sd_all_energies<-consumption%>%
  summarize(mean_oil=mean(oil_consumption), sd_oil=sd(oil_consumption), mean_other_renewable=mean(other_renewable_consumption), sd_other_renewable=sd(other_renewable_consumption), mean_renewables=mean(renewables_consumption), sd_renewables=sd(renewables_consumption), mean_wind=mean(wind_consumption), sd_wind=sd(wind_consumption), mean_solar=mean(solar_consumption), sd_solar=sd(solar_consumption))

mean_sd_all_energies

```

First, the mean and standard deviation by energy. We see that, of these energies, the highest consumption is of oil while the lowest is solar energy.

**For each country**

Divided by country we found that Canada is the one that consumes the most oil, while Haiti doesn’t consume it. Also, Venezuela is the one that consumes less solar energy. 
To get this data, we had to group by country, and then use the function *summarize* to get the final results. 

```{r}

mean_sd_by_country<-consumption%>%
  group_by(country)%>%
  summarize(mean_oil=mean(oil_consumption), sd_oil=sd(oil_consumption), mean_other_renewable=mean(other_renewable_consumption), sd_other_renewable=sd(other_renewable_consumption), mean_renewables=mean(renewables_consumption), sd_renewables=sd(renewables_consumption), mean_wind=mean(wind_consumption), sd_wind=sd(wind_consumption), mean_solar=mean(solar_consumption), sd_solar=sd(solar_consumption))

mean_sd_by_country

```

#### **Distribution**

```{r}

hist(consumption$oil_consumption)
hist(consumption$other_renewable_consumption)
hist(consumption$renewables_consumption)
hist(consumption$wind_consumption)
hist(consumption$solar_consumption)

```

For the distribution, we saw that the data of all the variables behaves almost the same, most of the registries are in the first places and then went down to the final locations. 

#### **Energy consumption per country**

To know the consumption of each energy in each country in the last year, we had to filter only the data registered in 2019, and then group it by country. However, if we wanted to analyze this data, we had to rewrite it in order to make an analysis (the way in which the dataset was ordered wasn’t functional for our purposes) that’s why we used the function *tribble* to create a new data frame ordered as we wanted. With that data, we calculated the percentages and then did the pie charts by country and energy type to understand what happened in the last year registered (2019). 

```{r}

consumption_2019<-consumption%>%
  filter(year==2019)%>%
  group_by(country)

consumption_2019_tb<-tribble(
  ~Country, ~Energy_type, ~Consumption,
  "Brazil", "Oil",        1314,
  "Brazil", "Other_renewable", 59.2,
  "Brazil", "Renewable",  726,
  "Brazil", "Wind",       42.786,
  "Brazil", "Solar",      5.687,
  "Canada", "Oil",        1250,
  "Canada", "Other_renewable", 26.8,
  "Canada", "Renewable",  726,
  "Canada", "Wind",       42.786,
  "Canada", "Solar",      5.687,
  "Haiti",  "Oil",        0,
  "Haiti",  "Other_renewable", 0,
  "Haiti",  "Renewable",  0,
  "Haiti",  "Wind",       0,
  "Haiti",  "Solar",      0,
  "Mexico", "Oil",        914,
  "Mexico", "Other_renewable", 19.2,
  "Mexico", "Renewable",  155,
  "Mexico", "Wind",       42.786,
  "Mexico", "Solar",      5.687,
  "Venezuela",  "Oil",        196,
  "Venezuela",  "Other_renewable", 0,
  "Venezuela",  "Renewable",  157,
  "Venezuela",  "Wind",       0.366,
  "Venezuela",  "Solar",      0.029,
)

consumption_2019_tb<-consumption_2019_tb%>%
  group_by(Country)%>%
  mutate(Total=sum(Consumption), Percentage=Consumption/Total*100)

ggplot(data=consumption_2019_tb,aes(x="",y=Percentage, fill=Energy_type))+
  geom_bar(stat = "identity",color="white")+
    geom_text(aes(label=percent(Percentage/100)),
              position=position_stack(vjust=0.9),color="black",size=2)+
  coord_polar(theta="y")+
  facet_wrap(~Country)+
  labs(title="Energy consumption in each country by energy type",
       subtitle="2019")

```

As we see, oil is the energy with a major presence in the countries, and it is followed by renewables. Sadly, we don’t have information about Haiti. 

#### **Growth**

To look for the growth of these energies in each country we used the function *geom_line* and *facet_wrap* to achieve this. 

```{r}

consumption_graphs<-consumption%>%
  mutate(year=as.numeric(year))%>%
  filter(year!=121)

ggplot(data=consumption_graphs, mapping=aes(x=year, y=oil_consumption))+
  geom_line()+
  facet_wrap(~country)+
  labs(title="Oil Consumption growth",
        subtitle="1900-2019")

ggplot(data=consumption_graphs, mapping=aes(x=year, y=other_renewable_consumption))+
  geom_line( color="turquoise4")+
  facet_wrap(~country)+
  labs(title="Other renewables Consumption growth",
        subtitle="1900-2019")

ggplot(data=consumption_graphs, mapping=aes(x=year, y=renewables_consumption))+
  geom_line( color="olivedrab3")+
  facet_wrap(~country)+
  labs(title="Renewables Consumption growth",
        subtitle="1900-2019")

ggplot(data=consumption_graphs, mapping=aes(x=year, y=wind_consumption))+
  geom_line( color="steelblue4")+
  facet_wrap(~country)+
  labs(title="Wind Consumption growth",
        subtitle="1900-2019")

ggplot(data=consumption_graphs, mapping=aes(x=year, y=solar_consumption))+
  geom_line( color="goldenrod4")+
  facet_wrap(~country)+
  labs(title="Solar Consumption growth",
        subtitle="1900-2019")

```

We found that Oil consumption had increased in Canada, Brazil, Mexico, and Venezuela but the Latin American countries went down in the final years. With other renewables, Canada and Mexico presented a growth, the same as Brazil which was bigger and maintained in the last years. In Wind and Solar, we see a big increase in the last few years.

### **Transactions**

In our last database Statistics, we have information about transactions made between countries regarding commodities used for energy. 

*In which units are measured?*

First, we want to know which units are calculated in these transactions while it changes depending on the commodity we are talking about. For this, we created a new object named “measures” and counted the commodity transactions and units. The informations is the following:

```{r}

measures<-statistics%>%
  count(commodity_transaction, unit)%>%
  select(commodity_transaction, unit)

measures

```

#### **Average and Standard Deviation**

**Average and Standard Deviation by Commodity Transaction**

To know the average and standard deviation of each commodity transacted, we grouped the commodities, summarize calculating the mean and standard deviation, and merged it with the last object created “measures”:

```{r}

mean_sd_transaction<-statistics%>%
  group_by(commodity_transaction)%>%
  summarize(mean=mean(quantity), sd=sd(quantity))%>%
  merge(measures)

mean_sd_transaction

```

**Average and Standard Deviation by Commodity Transaction and country**

To calculate this same information but divided by country, we made almost the same but grouped by country as well, so we found the following information. 

```{r}

mean_sd_transaction_country<-statistics%>%
  group_by(country_or_area, commodity_transaction)%>%
  summarize(mean=mean(quantity), sd=sd(quantity))%>%
  merge(measures)

mean_sd_transaction_country

```

#### **Distribution**

We also looked for the distribution divided by unit and commodity (we can’t combine data or units in this case). To do this we made new objects where we filtered the name of each commodity and did the graph based on it. 

```{r}

distribution_statistics_brcoal<-statistics%>%
  filter(commodity_transaction=="Brown coal - final consumption")%>%
  mutate(year=as.numeric(year))

ggplot(data=distribution_statistics_brcoal, mapping=aes(x=quantity))+
  geom_histogram(fill="tan4")+
  labs(title="Distribution Brown coal",
       subtitle="Transactions")

distribution_statistics_brcoalbriq<-statistics%>%
  filter(commodity_transaction=="Brown coal briquettes - final consumption")%>%
  mutate(year=as.numeric(year))

ggplot(data=distribution_statistics_brcoalbriq, mapping=aes(x=quantity))+
  geom_histogram(fill="tan3")+
  labs(title="Distribution Brown coal briquettes",
       subtitle="Transactions")

distribution_statistics_natgas<-statistics%>%
  filter(commodity_transaction=="Natural gas (including LNG) - final consumption")%>%
  mutate(year=as.numeric(year))

ggplot(data=distribution_statistics_natgas, mapping=aes(x=quantity))+
  geom_histogram(fill="seagreen4")+
  labs(title="Distribution Natural Gas",
       subtitle="Transactions")

distribution_statistics_pet<-statistics%>%
  filter(commodity_transaction=="Petroleum coke - final consumption")%>%
  mutate(year=as.numeric(year))

ggplot(data=distribution_statistics_pet, mapping=aes(x=quantity))+
  geom_histogram(fill="slategrey")+
  labs(title="Distribution Petroleum Coke",
       subtitle="Transactions")

```

Brown coal has a normal distribution, but briquettes change a lot. Natural gas has a distribution with a double spout, and petroleum presents a positive bias.

#### **Growth**

```{r}

ggplot(data=distribution_statistics_brcoal, mapping=aes(x=year, y=quantity))+
  geom_line(color="tan4")+
  facet_wrap(~country_or_area)+
  labs(title="Brown Coal Growth",
       subtitle="Transactions")

ggplot(data=distribution_statistics_brcoalbriq, mapping=aes(x=year, y=quantity))+
  geom_line(color="tan3")+
  facet_wrap(~country_or_area)+
  labs(title="Brown Coal Briquettes Growth",
       subtitle="Transactions")

ggplot(data=distribution_statistics_natgas, mapping=aes(x=year, y=quantity))+
  geom_line(color="seagreen4")+
  facet_wrap(~country_or_area)+
  labs(title="Natural Gas Growth",
       subtitle="Transactions")

ggplot(data=distribution_statistics_pet, mapping=aes(x=year, y=quantity))+
  geom_line(color="slategrey")+
  facet_wrap(~country_or_area)+
  labs(title="Petroleum Coke Growth",
       subtitle="Transactions")

```

Finally, to look for the growth, we used the same objects to create the graphs with *geom_line*. For Brown coal, we found that only Canada and Mexico present data, being the last one with the biggest growth. Brown Coal Briquettes is only in Mexico and presents a decrease. Natural Gas is present in Brazil, Canada, and Mexico, in all countries present almost the same behavior, increasing and decreasing, however, Canada is the one with the highest data. Finally, petroleum is also present in these three countries, Brazil is the one with the highest growth. 

*Which countries does not have an energy type for transactions?*

While we were doing this analysis, we found that there are some countries that are not present in the original database, which might think that doesn’t have transactions for those commodities. That’s why we wrote the next code, where we counted the countries and found that Venezuela and Haiti are not present. 

```{r}

country_or_area_transactions<-statistics%>%
  count(country_or_area)%>%
  select(country_or_area)

country_or_area_transactions

```

#### **Prices**

Finally, it’s important to consider prices, and after doing an investigation, we found global prices for the most important energy types present in these three databases, we used *tribble* to create a new data frame with that information, dividing it by energy type, unit in which it is measured and price. 

```{r}

prices<-tribble(
  ~Energy_type,  ~Unit,                     ~Price, 
  "Coal",        "US$/TM",                  128,                                     
  "Natural gas", "US$/Kwh",                 76,     
  "Petroleum",   "US$ per barrel",          85, 
  "Nuclear",     "US$/1000 kWh",            73,      
  "Oil",         "US$ per barrel",          17.220,  
  "Wind",        "US$/Kwh",                 0.066,
  "Solar",       "US$/Kwh",                 0.10
)

prices

```

All these lines were written so we can make a report to take the decision, which is the best option to invest, whether in renewable energies or non-renewable or both, specifically in Brazil, Canada, Mexico, Venezuela, and Haiti. 